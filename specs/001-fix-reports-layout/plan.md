# Implementation Plan: Reports Layout Polish

**Branch**: `001-fix-reports-layout` | **Date**: 2025-10-31 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-fix-reports-layout/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

This bug fix resolves two critical layout issues on the Reports screen that affect user experience in long-text languages:

1. **Summary Card Overflow Fix**: Replace the experimental `FlowRow` layout with a Material 3 `LazyRow` to enable horizontal scrolling of the three summary cards (Total Earnings, Total Hours, Active Students). This prevents layout breakage on narrow screens or with long translations like German.

2. **Bar Chart Label Occlusion Fix**: Modify the Canvas-based bar chart drawing logic to calculate bar heights by reserving space for month labels. Introduce text measurement to determine label height at runtime and ensure a minimum 4.dp padding between bars and labels, guaranteeing all six month labels remain visible even when the most recent month has maximum earnings.

**Technical Approach**: UI-only changes in `ReportsScreen.kt` using Compose's `LazyRow` for scrolling and `rememberTextMeasurer()` for dynamic label space calculation. No data model, ViewModel, or architecture layer changes required.

## Technical Context

**Language/Version**: Kotlin (K2) targeting JVM 17  
**Primary Dependencies**: Jetpack Compose Material 3, Hilt, Kotlin Coroutines & Flow, Room (KSP), Navigation Compose  
**Storage**: Room database with KSP processors (no KAPT)  
**Testing**: JUnit, kotlinx-coroutines-test, Compose UI tests, Room in-memory tests  
**Target Platform**: Android (per app `minSdk`) with Compose-only UI layer  
**Project Type**: Android mobile app using Clean Architecture (UI → ViewModel → UseCase → Repository → DataSource)  
**Performance Goals**: 60fps UI, <150ms state propagation, resilient offline persistence  
**Constraints**: No XML layouts, no alternative DI/navigation stacks, immutable data models, strings in `strings.xml`  
**Scale/Scope**: Multi-screen tutor management workflows within `com.barutdev.kora`

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Clean MVVM Contract**: Changes are **UI-only** within `ReportsScreen.kt`. No modifications to ViewModel, UseCase, Repository, or DataSource layers. Existing data flow (UI ← StateFlow ← ViewModel) remains unchanged.

✅ **Compose Material 3 Experience**: Using standard Material 3 `LazyRow` (already used in RangeFilterSection) and existing `Card` components. No XML layouts, no experimental APIs in final implementation (removing `FlowRow`). Typography measurement uses `MaterialTheme.typography.bodySmall` design token.

✅ **Kotlin Coroutines/Flow**: No async changes required. Existing StateFlow data binding to ReportsUiState remains unchanged.

✅ **Room & Immutable Data**: No database schema, DAO, or entity modifications. Domain models (`ReportSummary`, `MonthlyEarningsPoint`) remain immutable and unchanged.

✅ **Hilt & Navigation**: No new DI modules or bindings. No navigation route changes. Reports screen destination remains at existing entry point.

✅ **Strings & Localization**: No new user-facing strings required. All existing localized string keys (`R.string.reports_*`) are reused. Layout adapts to locale via Compose's automatic RTL support and text measurement.

**Compliance Summary**: All five constitution principles satisfied. This is a pure UI polish pass with zero architecture impact.

## Project Structure

### Documentation (this feature)

```text
specs/001-fix-reports-layout/
├── spec.md              # Feature specification (user stories, requirements, success criteria)
├── plan.md              # This file (implementation plan)
├── research.md          # Problem analysis and solution decisions
├── data-model.md        # UI component contracts and data flow
├── quickstart.md        # Step-by-step implementation guide
└── tasks.md             # Will be generated by /speckit.tasks command (NOT created by /speckit.plan)
```

**Note**: No `contracts/` directory needed - this is a UI-only bug fix with no API changes.

### Source Code (repository root)

```text
app/
├── src/main/java/com/barutdev/kora/
│   ├── data/
│   │   ├── datasource/
│   │   └── repository/
│   ├── di/
│   ├── domain/
│   │   ├── model/
│   │   └── usecase/
│   ├── navigation/
│   └── ui/
│       ├── components/
│       └── screens/
└── src/main/res/
    ├── values/strings.xml
    └── values-*/strings.xml

app/src/androidTest/...
app/src/test/...
```

**Structure Decision**:

**Affected Files**:
- `app/src/main/java/com/barutdev/kora/ui/screens/reports/ReportsScreen.kt` - Primary implementation file
  - Lines 241-305: `SummaryCards()` composable (FlowRow → LazyRow replacement)
  - Lines 428-481: `BarChart()` composable (label space calculation)
  - Lines 396-402: Constants section (add `ReportsChartMinLabelPadding`)

**Unchanged Files**:
- `ReportsViewModel.kt` - No changes to state management
- `ReportsUiState.kt` - No changes to UI state data class
- `ReportsModels.kt` - No changes to domain models
- All repository, use case, and data source files - No changes

**No new packages or modules created** - all changes are within existing `ui.screens.reports` package.

## Complexity Tracking

**No violations detected** - Constitution Check passed with all principles satisfied.

This bug fix introduces zero architectural complexity:
- No new layers or abstractions
- No new dependencies
- No experimental APIs in final implementation (removing existing `@OptIn(ExperimentalLayoutApi)`)
- Uses existing Compose primitives (`LazyRow`, `rememberTextMeasurer`)

**Complexity reduction**: Replacing experimental `FlowRow` with stable `LazyRow` actually reduces technical debt.

---

## Phase 0: Research & Analysis ✅ COMPLETED

**Objective**: Understand current implementation and design solutions for both layout issues.

### Research Findings

Documented in [research.md](./research.md):

#### Issue 1: Summary Card Overflow
- **Root Cause**: `FlowRow` wraps entire cards but doesn't provide scrolling
- **Solution**: Replace with `LazyRow` for horizontal scrolling
- **Precedent**: RangeFilterSection already uses LazyRow successfully (lines 210-238)

#### Issue 2: Bar Chart Label Occlusion
- **Root Cause**: Bar height calculation uses full chart height (160.dp), pushing labels outside visible area
- **Solution**: Reserve space for labels by measuring text height at runtime and calculating available bar height
- **Formula**: `availableBarHeight = chartHeight - labelHeight - minPadding(4dp) - spacer(8dp)`

### Best Practices Applied
- Material 3 LazyRow patterns
- Compose text measurement API (`rememberTextMeasurer`)
- Accessibility considerations (scroll announcements, font scaling)
- RTL layout support (automatic via Compose)

### Technology Decisions
| Technology | Decision | Rationale |
|------------|----------|-----------|
| Layout for cards | LazyRow | Standard Compose API, already used elsewhere in screen |
| Text measurement | rememberTextMeasurer | Runtime measurement accounts for locale, font scaling, accessibility |
| Card sizing | Fixed 160.dp width | Consistent card size, allows 2-3 cards visible on phone screens |
| Label padding | 4.dp minimum | Sufficient clearance for readability per Material Design spacing guidelines |

---

## Phase 1: Design & Contracts ✅ COMPLETED

**Objective**: Document UI component contracts and implementation details.

### Data Model

Documented in [data-model.md](./data-model.md):

**No data model changes required** - UI-only modifications.

### UI Component Contracts

#### SummaryCards Composable
```kotlin
@Composable
private fun SummaryCards(
    summary: ReportSummary,      // Unchanged input
    locale: Locale,              // Unchanged input
    currencyFormatter: NumberFormat,  // Unchanged input
    modifier: Modifier = Modifier     // Unchanged input
)
```

**Changes**:
- Remove `@OptIn(ExperimentalLayoutApi::class)`
- Replace `FlowRow` with `LazyRow`
- Use `item()` DSL with stable keys
- Change card modifiers: `.weight(1f, fill = true).fillMaxWidth()` → `.width(160.dp)`

#### BarChart Composable
```kotlin
@Composable
private fun BarChart(
    bars: List<ChartBar>,        // Unchanged input
    locale: Locale,              // Unchanged input
    modifier: Modifier = Modifier,    // Unchanged input
    chartHeight: Dp = ReportsChartHeight  // Unchanged input
)
```

**Changes**:
- Add text measurement logic before Row
- Calculate `availableBarHeight` for bar sizing
- Replace `chartHeight.value` with `availableBarHeight.value` in height calculation
- Add new constant: `ReportsChartMinLabelPadding = 4.dp`

### Implementation Guide

Detailed step-by-step instructions in [quickstart.md](./quickstart.md):
- Exact code replacements with before/after snippets
- Import changes required
- Verification steps
- Troubleshooting guide
- Rollback plan

---

## Phase 2: Implementation Planning

**Objective**: Break down implementation into atomic tasks for `/speckit.tasks` command.

### Implementation Breakdown

#### Task 1: Fix Summary Card Overflow
**File**: `ReportsScreen.kt`
**Lines**: 8, 241-305
**Estimated time**: 15 minutes

1. Remove `ExperimentalLayoutApi` import (line 8)
2. Remove `@OptIn(ExperimentalLayoutApi::class)` annotation (line 241)
3. Replace `FlowRow` with `LazyRow` in SummaryCards function
4. Convert three child cards to `item()` DSL with keys
5. Update card modifiers to use fixed `.width(160.dp)`
6. Add `contentPadding` to LazyRow

**Acceptance**: Cards scroll horizontally without layout breakage in German locale.

#### Task 2: Fix Bar Chart Label Occlusion
**File**: `ReportsScreen.kt`
**Lines**: 36-52 (imports), 401 (constants), 428-481 (BarChart function)
**Estimated time**: 20 minutes

1. Add `rememberTextMeasurer` import
2. Add `ReportsChartMinLabelPadding = 4.dp` constant after line 402
3. Add text measurement logic at start of BarChart composable
4. Calculate `availableBarHeight` from measured label dimensions
5. Replace `chartHeight.value` with `availableBarHeight.value` in bar height formula

**Acceptance**: All 6 month labels visible, including for maximum earnings month.

#### Task 3: Build and Manual Testing
**Estimated time**: 10 minutes

1. Run `./gradlew assembleDebug` - verify build succeeds
2. Test summary cards in English and German locales
3. Test bar chart with various earnings data
4. Verify accessibility with font scaling at 200%

**Acceptance**: No build errors, both fixes visually confirmed.

#### Task 4: Run Automated Tests
**Estimated time**: 5 minutes (execution only)

1. Run `./gradlew connectedDebugAndroidTest`
2. Verify all tests pass
3. If layout-related tests fail, update assertions (FlowRow → LazyRow)

**Acceptance**: Test suite passes with 0 failures (per spec FR-004).

### Total Estimated Effort
- Implementation: ~35 minutes
- Testing: ~15 minutes
- **Total**: ~50 minutes

### Risk Assessment
- **Technical Risk**: Low - isolated UI changes, no cross-layer dependencies
- **Testing Risk**: Low - existing tests should pass, changes are additive
- **Localization Risk**: Low - no new strings, text measurement handles all locales
- **Performance Risk**: Negligible - LazyRow is optimized for scrolling, text measurement is memoized

---

## Testing Strategy

### Manual Testing Requirements (from spec)

**User Story 1 - Summary Cards** (SC-001):
- [ ] German locale: All cards readable, horizontal scrolling works
- [ ] Narrow phone screen: Cards extend beyond viewport, scroll reveals remaining cards
- [ ] Tablet landscape: Cards may fit without scrolling, verify no layout distortion

**User Story 2 - Month Labels** (SC-002):
- [ ] Maximum earnings month: Label fully visible with clearance
- [ ] All 6 labels visible in all tested locales
- [ ] German month names (longer): Labels not clipped

**Edge Cases** (from spec):
- [ ] Accessibility font scaling at maximum (200%)
- [ ] Landscape orientation on tablets
- [ ] RTL locales (Arabic): Scrolling direction reverses correctly
- [ ] Zero earnings month: Label still visible with minimum bar height
- [ ] Offline mode: Cached data displays correctly

### Automated Testing (FR-004)

**Command**: `./gradlew connectedDebugAndroidTest`

**Expected Outcomes**:
- All existing UI tests pass
- No regressions in ReportsScreen tests
- Compose tree assertions may need updates if they assert on FlowRow presence

**Potential Test Updates**:
```kotlin
// Before: composeTestRule.onNode(hasTestTag("reports_summary_cards")).assertExists()
// After: Update if test specifically checks for FlowRow node type
```

### Accessibility Testing (SC-003)

**TalkBack/Screen Reader**:
- Cards announce "Total Earnings: [value]" correctly
- Horizontal scroll gesture works and announces "scrollable horizontally"
- Bar descriptions unchanged: "June: $1,234" announcements preserved

**Keyboard Navigation**:
- Tab through cards works in LazyRow (same as existing RangeFilterSection)
- Arrow keys scroll cards horizontally

### Performance Testing

**Metrics**:
- Frame rate: Maintain 60fps during card scrolling
- Recomposition: Text measurement memoized with `remember()`, only recalculates on style/locale change
- Memory: LazyRow composition similar to existing RangeFilterSection

**No expected degradation** - LazyRow is standard Compose primitive with built-in optimization.

---

## Deployment Checklist

### Pre-Merge
- [ ] All tasks in tasks.md completed
- [ ] Build succeeds: `./gradlew assembleDebug`
- [ ] Automated tests pass: `./gradlew connectedDebugAndroidTest`
- [ ] Manual testing completed for all edge cases
- [ ] Screenshots captured: English, German, Arabic locales
- [ ] QA review requested with locale testing

### Merge Requirements
- [ ] Pull request created with screenshots
- [ ] Code review approved (UI changes only, low risk)
- [ ] CI/CD pipeline passes all checks
- [ ] No merge conflicts with main branch

### Post-Merge
- [ ] Monitor crash reports for text measurement edge cases
- [ ] User feedback: Confirm German users report layout fixed
- [ ] Release notes updated: "Fixed Reports screen layout issues in long-text languages"

---

## Success Metrics

**From spec.md Success Criteria**:

| ID | Metric | Target | Verification Method |
|----|--------|--------|---------------------|
| SC-001 | Summary cards readable in 3 locales | 0 layout breakages | QA screenshots: en, de, ar |
| SC-002 | Month labels visible | 100% of 6 labels | Visual inspection across device sizes |
| SC-003 | Accessibility support | Scroll + VoiceOver work | TalkBack testing on Android |
| SC-004 | Automated tests pass | 0 failures | `./gradlew connectedDebugAndroidTest` |

**Additional Metrics**:
- Code churn: ~40 lines in 1 file (low risk)
- Technical debt reduction: Remove experimental API usage
- User satisfaction: German locale users report improved readability

---

## Rollback Plan

**If critical issues discovered post-merge:**

### Option 1: Hot Fix
If minor issues (e.g., card width too narrow):
1. Adjust constants (`160.dp` → `180.dp`)
2. Deploy hot fix in patch release

### Option 2: Full Revert
If major issues (e.g., text measurement crashes):
1. Revert commit: `git revert <commit-sha>`
2. Restore original FlowRow implementation
3. Re-evaluate approach (e.g., increase chart height instead of label space reservation)

### Revert Procedure
```bash
# Create revert branch
git checkout -b revert-001-fix-reports-layout

# Revert the merge commit
git revert -m 1 <merge-commit-sha>

# Create PR for revert
gh pr create --title "Revert: Reports layout polish" --body "Reverting due to [specific issue]"
```

**Revert Risk**: Low - changes are isolated, no data migrations or API changes to roll back.

---

## Appendix

### Related Documentation
- [Feature Specification](./spec.md) - User stories and requirements
- [Research Document](./research.md) - Problem analysis and solution decisions
- [Data Model](./data-model.md) - UI component contracts
- [Quick Start Guide](./quickstart.md) - Step-by-step implementation instructions
- [Kora Constitution](.specify/memory/constitution.md) - Project governance principles

### External References
- [Compose LazyRow Documentation](https://developer.android.com/jetpack/compose/lists#lazy)
- [Text Measurement in Compose](https://developer.android.com/jetpack/compose/text#measure-text)
- [Material 3 Cards](https://m3.material.io/components/cards)
- [Android Accessibility Guidelines](https://developer.android.com/guide/topics/ui/accessibility)

### Change History
| Date | Version | Changes |
|------|---------|---------|
| 2025-10-31 | 1.0 | Initial implementation plan generated by `/speckit.plan` |

---

**Plan Status**: ✅ Ready for Task Generation (`/speckit.tasks`)

**Next Command**: Run `/speckit.tasks` to generate actionable task list in `tasks.md`
